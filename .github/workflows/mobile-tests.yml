name: Mobile Tests with Appium + Sauce Labs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-mobile:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Instalar Node.js e Appium
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - run: npm install -g appium

      - name: Verificar versão do Appium
        run: appium -v

      - name: Upload APK para Sauce Labs
        env:
          SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
          SAUCE_ACCESS_KEY: ${{ secrets.SAUCE_ACCESS_KEY }}
        run: |
          echo "Enviando APK para Sauce Storage..."
          curl -u "$SAUCE_USERNAME:$SAUCE_ACCESS_KEY" \
            -X POST "https://api.us-west-1.saucelabs.com/v1/storage/upload" \
            -F "payload=@src/test/resources/app/Android-MyDemoAppRN.1.3.0.build-244.apk" \
            -F "name=Android-MyDemoAppRN.1.3.0.build-244.apk"

      - name: Executar testes no Sauce Labs
        env:
          SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
          SAUCE_ACCESS_KEY: ${{ secrets.SAUCE_ACCESS_KEY }}
        run: mvn clean verify -Dappium.server=https://$SAUCE_USERNAME:$SAUCE_ACCESS_KEY@ondemand.us-west-1.saucelabs.c_


      - name: Publicar Cucumber HTML Report no GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/cucumber-reports
          publish_branch: gh-pages

      - name: Listar pasta target para depuração
        run: ls -R target || true
